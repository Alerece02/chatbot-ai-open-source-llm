<!-- Chatbot Launcher Button -->
<div id="chatbot-launcher" class="fixed bottom-6 right-6 z-50">
  <button onclick="mostraChat()" 
          class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all transform hover:scale-110 pulse-animation"
          aria-label="Apri assistente virtuale">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-4l-4 4z"></path>
    </svg>
    <span class="notification-badge hidden"></span>
  </button>
</div>

<!-- Chat Modal Window -->
<div id="chatModal" class="fixed bottom-20 right-6 hidden z-40 chat-animation">
  <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-2xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <span class="text-xl">ü§ñ</span>
          </div>
          <div>
            <h2 class="text-lg font-semibold">Assistente ULSS9</h2>
            <p class="text-xs opacity-90">Sempre pronto ad aiutarti</p>
          </div>
        </div>
        <button onclick="nascondiChat()" 
                class="text-white/80 hover:text-white transition"
                aria-label="Chiudi chat">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Accessibility Controls -->
    <div class="bg-gray-50 px-4 py-2 border-b flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <button onclick="aumentaFontChat()" 
                class="p-1 rounded hover:bg-gray-200 transition"
                aria-label="Aumenta testo"
                title="Aumenta dimensione testo">
          <span class="font-bold text-sm">A+</span>
        </button>
        <button onclick="diminuisciFontChat()" 
                class="p-1 rounded hover:bg-gray-200 transition"
                aria-label="Diminuisci testo"
                title="Diminuisci dimensione testo">
          <span class="font-bold text-xs">A-</span>
        </button>
        <button onclick="toggleVoiceOutput()" 
                class="p-1 rounded hover:bg-gray-200 transition"
                aria-label="Attiva/Disattiva voce"
                title="Lettura vocale">
          <span id="voiceIcon">üîá</span>
        </button>
      </div>
      <span class="text-xs text-gray-500">Chat sicura e privata</span>
    </div>

    <!-- Chat Messages Area -->
    <div id="storico" class="flex flex-col gap-3 p-4 max-h-96 min-h-[300px] overflow-y-auto bg-gray-50">
      <!-- Welcome Message -->
      <div class="self-start bg-white text-gray-800 px-4 py-3 rounded-xl rounded-tl-none shadow-sm max-w-[85%]">
        <p class="text-sm">üëã Ciao! Sono l'assistente virtuale dell'ULSS9.</p>
        <p class="text-sm mt-1">Come posso aiutarti oggi?</p>
      </div>
    </div>

    <!-- Suggested Questions -->
    <div id="suggestedQuestions" class="px-4 py-2 bg-white border-t">
      <p class="text-xs text-gray-500 mb-2">Domande suggerite:</p>
      <div class="flex flex-wrap gap-2">
        <button onclick="quickAsk('Orari centro prelievi')" 
                class="quick-btn bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs hover:bg-blue-100 transition">
          üïê Orari prelievi
        </button>
        <button onclick="quickAsk('Come prenoto una visita')" 
                class="quick-btn bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs hover:bg-green-100 transition">
          üìÖ Prenotazioni
        </button>
        <button onclick="quickAsk('Dove trovo il pronto soccorso')" 
                class="quick-btn bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs hover:bg-red-100 transition">
          üö® Pronto Soccorso
        </button>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 bg-white rounded-b-2xl border-t">
      <div class="flex gap-2">
        <input id="domanda" 
               type="text" 
               class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-blue-400 transition"
               placeholder="Scrivi la tua domanda..."
               onkeypress="if(event.key === 'Enter') chiedi()"
               aria-label="Campo domanda">
        
        <button onclick="attivaVoce()" 
                class="p-3 bg-yellow-400 text-gray-800 rounded-xl hover:bg-yellow-500 transition"
                aria-label="Input vocale"
                title="Parla per chiedere">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
          </svg>
        </button>
        
        <button onclick="chiedi()" 
                class="px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-medium"
                aria-label="Invia domanda">
          Invia
        </button>
      </div>
      
      <!-- Voice Feedback -->
      <div id="voiceFeedback" class="hidden mt-2 text-xs text-center text-gray-500">
        <span class="inline-flex items-center">
          <span class="recording-dot"></span>
          Sto ascoltando...
        </span>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="statusBar" class="hidden px-4 py-2 bg-gray-100 text-xs text-gray-600 rounded-b-2xl">
      <span id="statusText">Elaborazione in corso...</span>
    </div>
    
  </div>
</div>

<style>
  /* Animazioni chat */
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .chat-animation {
    animation: slideUp 0.3s ease-out;
  }
  
  /* Pulsante pulsante */
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
    }
  }
  
  .pulse-animation {
    animation: pulse 2s infinite;
  }
  
  /* Indicatore di registrazione */
  .recording-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #ef4444;
    border-radius: 50%;
    margin-right: 6px;
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  
  /* Badge di notifica */
  .notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 12px;
    height: 12px;
    background-color: #ef4444;
    border-radius: 50%;
    border: 2px solid white;
  }
  
  /* Messaggi chat */
  .message-user {
    animation: slideInRight 0.3s ease-out;
  }
  
  .message-ai {
    animation: slideInLeft 0.3s ease-out;
  }
  
  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  /* Scrollbar personalizzata */
  #storico::-webkit-scrollbar {
    width: 6px;
  }
  
  #storico::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 3px;
  }
  
  #storico::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 3px;
  }
  
  #storico::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }
</style>